---
title: "dd6"
output: html_notebook
author: James Orr
---

Quick look at dd6 results

Set up 

```{r}
#### Required packages
library(tidyverse)        

#### Clear  environment 
rm(list = ls())   
```

Load data

```{r}
CC <- read.csv("data/cfu_counts_JO.csv")
outflow <- read.csv("data/outflow_rates_JO.csv")
od <- read.csv("data/OD/od_JO.csv")
```


Average counts

```{r}
CC <- CC %>%
  mutate(av_counts = rowMeans(across(dot1:dot10), na.rm = TRUE))
```

Densities

```{r}
CC <- CC %>%
  
  # multiply by 10^dilution factor to get CFUs per ul 
  # first row is 100ul of sample so it would be: count * 10 ^ 1 to get 1ul
  # six row would be: count * 10 ^ 6 to get to 1ul
  # remember that the very first row is diluted!
  mutate(cfu_undil = av_counts * 10^dilution_factor) %>%
  
  # each dot is 5ul, so divide by 5 to get counts per ul
  mutate(cfu_ul = cfu_undil) #/ 5)

########## KD's data actually didn't divide by 5 in the end########## 
# She intended to, but I'll also leave it out now just for comparison
# I'll go through all the raw data at some stage to do a full analysis
```

Create sampling factor 

```{r}
CC <- CC %>%
  
  # removes the counts from the overnights
  filter(day != 0) %>%
  
  # factor for every combination of day and time and experiment_replicate
  mutate(sample = interaction(day, time, experiment_replicate))
```


Quick plot of CFUs by inflow setting (comparing across DD6 and DD7)

```{r, fig.height=4, fig.width=7}

## only keep days 1 (and 2) for now and remove M1 from dd6 (pump stopped)
CC_plot <- CC %>%
  #filter(day %in% c(1, 2)) %>%
  filter(day == 1) %>%
  filter(!(ID == "M1" & experiment_replicate == "dd6"))

ggplot(CC_plot, aes(x = cfu_ul, y = inflow_setting, color = sample)) +
  geom_point() + 
  labs(x = "CFU/μL", y = "Inflow setting", color = "Sample") +
  theme_minimal()
```

Quick plot of OD by inflow setting (comparing across DD6 and DD7)

```{r, fig.height=4, fig.width=7}

# all variables (except OD) are named consistently
CC <- CC %>%
  left_join(od, by = join_by(experiment_replicate, day, time, ID))

## only keep days 1 and 2 for now and remove M1 from dd6 (pump stopped)
CC_plot <- CC %>%
  filter(day %in% c(1, 2)) %>%
  filter(!(ID == "M1" & experiment_replicate == "dd6"))

ggplot(CC_plot, aes(x = OD, y = inflow_setting, color = sample)) +
  geom_point() + 
  labs(x = "OD", y = "Inflow setting", color = "Sample") +
  theme_minimal()
```



Join in outflow volumes 

```{r}
# mean outflow volume across day 1 and day 2 per bioreactor
outflow <- outflow %>%
  select(c(bioreactor, day_measured, volume_out)) %>%
  group_by(bioreactor) %>%
  summarise(outflow_mean = mean(volume_out))

# join the mean outflow volume into colony count data (by ID/bioreactor)
CC <- CC %>%
  left_join(outflow, by = c("ID" = "bioreactor"))
```

Join in the OD data (does this need to be "blanked" - should we minus everything by M5?)

```{r}
# all variables (except OD) are named consistently
CC <- CC %>%
  left_join(od, by = join_by(experiment_replicate, day, time, ID))

# blank? Minus value of M5 (control) from others within a sampling period  
CC <- CC %>%
  group_by(sample) %>%                   
  mutate(control_OD = OD[ID == "M5"],          
         OD_blanked = OD - control_OD) %>%        
  ungroup()                         

```


Calculate dilution rate (this seems to be what Kaleigh used for y axis)

```{r}
CC <- CC %>%
  
  # volume coming in every hour (in ml)
  mutate(outflow_per_hour = outflow_mean/24) %>%
  
  # as a fraction of the volume of the vial (21ml) to get rate of dilution 
  mutate(dilution_rate = outflow_per_hour/21)
```

Quick plots of CFUs by dilution rate

```{r, fig.height=4, fig.width=7}

# removing the control (all at 0) and M1 reactor - pump failed on first day
CC_plot <- CC %>%
  filter(!(ID %in% c("M1", "M5")))


ggplot(CC_plot, aes(x = cfu_ul, y = dilution_rate, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 1) + 
  labs(x = "CFU/μL", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_minimal()

```

```{r}
ggplot(CC_plot, aes(x = cfu_ul, y = dilution_rate, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 10) + 
  labs(x = "CFU/μL", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_light() +
  facet_wrap(~ sample, scales = "free_x")
```


Quick plots of OD by dilution rate

```{r, fig.height=4, fig.width=7}

ggplot(CC_plot, aes(x = OD_blanked, y = dilution_rate, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 1) + 
  labs(x = "OD", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_minimal()

```


Compare my OD data with Kaleigh's OD data 

```{r}
# from DD2 and DD3
KD_data <- read.csv("data/KD/KD_final_data.csv")

# from DD4
dd4 <- read.csv("data/KD/dd4_OD.csv")
dd4 <- dd4 %>%
  filter(read_date == "29/06/2024") %>%
  mutate(blank_OD = absorb_600[bioreactor == "blank"],          
         OD_blanked = absorb_600 - blank_OD) %>%
  select(OD_blanked, bioreactor) %>%
  mutate(experiment_replicate = "dd4")

# join together all of KD's data
KD_data <- KD_data %>%
  left_join(dd4) %>%
  mutate(final_od = ifelse(experiment_replicate == "dd4", 
                           OD_blanked,
                           final_od))

# join in my data from dd6
merged <- CC_plot %>%
  select(c(experiment_replicate, OD_blanked, dilution_rate, sample, ID)) %>%
  rename(mean_dil_inv_hr = dilution_rate) %>%
  
  # choose day 2 or day 3
  rename(final_od = OD_blanked) %>%
  filter(sample == "2.b") %>%
  
  # average day 2 and day 3
  #filter(sample %in% c("2.b", "3.b")) %>%
  #group_by(ID, mean_dil_inv_hr, experiment_replicate) %>%
  #summarise(final_od = mean(OD_blanked)) %>%
  #ungroup() %>%

  full_join(KD_data)
```

```{r, fig.height=4, fig.width=7}
merged_plotting <- merged %>%
  filter(experiment_replicate %in% c("dd2", "dd3", "dd4", "dd6")) %>%
  filter(final_od > 0)

ggplot(merged_plotting, aes(x = final_od, 
                            y = mean_dil_inv_hr, 
                            color = experiment_replicate)) +
  geom_point() + 
  labs(x = "OD", y = "Dilution rate (ml/hour/ml)", color = "Experiment") +
  theme_minimal()
```

End points for the experiments: 
DD2 - Day 2 
DD3 - Day 4 / Day 6 
DD4 - Day 4 
DD6 - Day 2 / Day 3



Compare CFUs across the dd experiments 

- ahhhh I see the problem! In Kaleigh's code she seems to make a small mistake on L373 - uses undiluted (i.e., full dot, which is 5ul) rather than cfus per ul! 

```{r}
KD_cfu <- KD_data %>%
  select(experiment_replicate, mean_dil_inv_hr, cfu_per_ul_tf) %>%
  filter(experiment_replicate %in% c("dd2", "dd3", "dd4")) %>%
  distinct()

JO_cfu <- CC_plot %>%
  filter(sample == "2.b") %>%
  select(experiment_replicate, cfu_ul, dilution_rate) %>%
  rename(cfu_per_ul_tf = cfu_ul) %>%
  rename(mean_dil_inv_hr = dilution_rate)

combined_cfu <- rbind(KD_cfu, JO_cfu)
```

```{r, fig.height=4, fig.width=7}

ggplot(combined_cfu, aes(x = cfu_per_ul_tf, 
                         y = mean_dil_inv_hr, 
                         color = experiment_replicate)) +
  geom_point() + 
  labs(x = "CFU (per ul)", y = "Dilution rate (ml/hour/ml)", color = "Experiment") +
  theme_minimal()
```













Check correlation between outflow volume and inflow setting

```{r, fig.width=4, fig.height=4}
ggplot(CC, aes(x = inflow_setting, y = outflow_mean)) +
  geom_point() +  # Scatter plot points
  geom_text(aes(label = ID), vjust = 1.5, hjust = 0, size = 3) + 
  labs(x = "Inflow setting", y = "Outflow (ml/day") +
  theme_minimal()
```


Check correlation between before and after sampling on day 2 

```{r, fig.width=4, fig.height=4}

CC_wide <- CC %>%
  
  select(ID, sample, cfu_ul) %>%
  
    pivot_wider(names_from = sample, 
                values_from = cfu_ul, 
                names_prefix = "cfu_ul_") %>%
  
  filter(ID != "M5")


ggplot(CC_wide, aes(x = cfu_ul_2.b, y = cfu_ul_2.a)) +
  geom_point() +  # Scatter plot points
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_text(aes(label = ID), vjust = 1.5, hjust = 0, size = 3) + 
  labs(x = "CFU Before", y = "CFU After") +
  theme_minimal()

```





