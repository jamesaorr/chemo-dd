---
title: "chemo-dd: data organisation"
output: html_notebook
author: James Orr
---

Organising the data (colony counts, od reads, outflow volumes) from the density-dependence experiments with e. coli in chemostats in the Letten lab. 

dd2, dd3, and dd4 conducted by Kaleigh Davis

dd6, and dd7 conducted by James Orr and Alicia Williams


### Set up environment 

Load packages and clear environment 

```{r}
#### Required packages
library(tidyverse)        

#### Clear  environment 
rm(list = ls())   
```

Load data

```{r}
# cfu data
cfu_jo <- read.csv("data/cfu/cfu_counts_jo.csv")
cfu_kd <- read.csv("data/cfu/cfu_counts_kd.csv")

# od data
od_jo <- read.csv("data/od/od_jo.csv")
od_kd <- read.csv("data/od/od_kd.csv")

# outflow data
outflow_jo <- read.csv("data/outflow/outflow_rates_jo.csv")
outflow_kd <- read.csv("data/outflow/outflow_rates_kd.csv")
```

### Colony counts

Merge data and do some initial filtering 

```{r}
# join two dataframes
cfu <- cfu_jo %>%
  select(-inflow_setting)  %>%
  bind_rows(cfu_kd) %>%
  select(-date)

# filtering out data that we can't use
cfu <- cfu %>%
  # remove the sample that was taken after inflow pumps in dd6
  filter(time != "a") %>%
  select(-c(time)) %>%
  # remove overnights
  filter(day != "0") %>%
  # remove media tests
  filter(sample_media != "media") %>%
  select(-c(sample_media)) %>%
  # keep on lb plates
  filter(plate_type == "lb") %>%
  select(-c(plate_type)) %>%
  # remove day 6 of dd3 (no data recorded)
  filter(!(experiment_replicate == "dd3" & day == 6))

# remove old dataframes
rm(list = c("cfu_jo", "cfu_kd"))   

```

Average counts

```{r}
cfu <- cfu %>%
  mutate(av_counts = rowMeans(across(dot1:dot10), na.rm = TRUE))
```

Densities

```{r}
cfu <- cfu %>%
  
  # multiply by 10^dilution factor to get CFUs per ul 
  # first row is 100ul of sample so it would be: count * 10 ^ 1 to get 1ul
  # six row would be: count * 10 ^ 6 to get to 1ul
  # remember that the very first row is diluted!
  mutate(cfu_undil = av_counts * 10^dilution_factor) %>%
  
  # each dot is 5ul, so divide by 5 to get counts per ul
  mutate(cfu_ul = cfu_undil/5)
```

Final dataframe

```{r}
cfu <- cfu %>%
  select(c(experiment_replicate, day, ID, cfu_ul))
```

### Outflow data

Merge dataframes

```{r}
outflow <- outflow_jo %>%
  # get the names the same
  rename(volume_out_round = volume_out) %>%
  rename(time_elapsed_round = time_elapsed) %>%
  # merge dataframes
  bind_rows(outflow_kd) %>%
  # remove some columns 
  select(-c(volume_out_full, time_elapsed_full, 
            exp_start_date, day_measured, species,
            media.bottle)) %>%
  # remove dd1 (failed after 10 hours)
  filter(experiment_rep != "dd1")

# remove old dataframes
rm(list = c("outflow_jo", "outflow_kd"))   
```

Get volume per hour 

```{r}
outflow <- outflow %>%
  mutate(outflow_per_hour = volume_out_round/time_elapsed_round) 
```

Average across each measurement of the same reactor 

```{r}
outflow <- outflow %>%
  group_by(bioreactor, experiment_rep, inflow_setting) %>%
  summarise(outflow_per_hour_mean = mean(outflow_per_hour))

#plot(outflow$inflow_setting, outflow$outflow_per_hour_mean)
```

Calculate dilution rate

```{r}
outflow <- outflow %>%
  
  # as a fraction of the volume of the vial (21ml) to get rate of dilution 
  mutate(dilution_rate = outflow_per_hour_mean/21)
```



### OD data

Merge dataframes and quick clean up

```{r}
od <- od_jo %>%
  bind_rows(od_kd)

# remove the sample that was taken after inflow pumps in dd6
od <- od %>%
  filter(time == "b") %>%
  select(-c(time))

# remove old dataframes
rm(list = c("od_jo", "od_kd"))   
```

Blanking (across each combination of experiment replicate and day)

```{r}
# group the dataframe by the unique combination of experiment_replicate and day
od <- od %>%
  group_by(experiment_replicate, day) %>%

  # create a new variable 'OD_control_value' that stores the OD value where OD_control == 1
  mutate(OD_control_value = ifelse(OD_control == 1, OD, NA)) %>%

  # fill missing values (NA) within each group by carrying the OD_control_value down and up
  fill(OD_control_value, .direction = "downup") %>%
  
  # create new varaible for blanked od
  mutate(od_blanked = OD - OD_control_value) %>%
  
  # set negative values to 0 (when controls were blanked with media - tiny differences)
  mutate(od_blanked = ifelse(od_blanked < 0, 0, od_blanked))
```

Some final cleaning 

```{r}
od <- od %>%
  
  # remove dd1 (failed after 10 hours)
  filter(experiment_replicate != "dd1") %>%
  
  # keep the reactor values only 
  filter(ID %in% c("M0", "M1", "M2", "M3",
                   "M4", "M5", "M6", "M7")) %>%
  
  # select the variables we want
  select(c(experiment_replicate, day, ID, od_blanked))
  
```









Quick plots of CFUs by dilution rate

```{r, fig.height=4, fig.width=7}

# removing some reactors
CC_plot <- CC %>%
  # for dd6, remove control (M5) and M1, whose pump stopped during day 1
  filter(!(ID %in% c("M1", "M5") & experiment_replicate == "dd6")) %>%
  # for dd7, remove control (M2)
  filter(!(ID %in% c("M2") & experiment_replicate == "dd7")) %>%
  # and remove M3 for day 3 that turned to batch at end of day 2
  filter(!(ID %in% c("M3") & experiment_replicate == "dd7" & day %in% c(3, 4))) %>%
  
  # choose which day to plot 
  filter(day %in% c(2)) %>%
  # choose an expeirment 
  filter(experiment_replicate %in% c("dd7", "dd6"))


ggplot(CC_plot, aes(x = cfu_ul, y = dilution_rate, color = sample)) +
  geom_point() + 
  labs(x = "CFU/μL", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_minimal()

```

```{r}
ggplot(CC, aes(x = cfu_ul, y = dilution_rate, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 10) + 
  labs(x = "CFU/μL", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_light() +
  facet_wrap(~ sample, scales = "free_x")
```


Quick plots of OD by dilution rate

```{r, fig.height=4, fig.width=7}

# removing some reactors
CC_plot <- CC %>%
  # for dd6, remove control (M5) and M1, whose pump stopped during day 1
  filter(!(ID %in% c("M1", "M5") & experiment_replicate == "dd6")) %>%
  # for dd7, remove control (M2)
  filter(!(ID %in% c("M2") & experiment_replicate == "dd7")) %>%
  # and remove M3 from day 3 that turned to batch at end of day 2
  filter(!(ID %in% c("M3") & experiment_replicate == "dd7" & day %in% c(3, 4))) %>%
  
  # day 3 sampling for dd6 was weird? Not just CC - OD as well seamed way off 
  #filter(!(experiment_replicate %in% c("dd6") & day %in% c(3))) %>%
  # remove sample "after" pumps for day two for dd6 for now - will average out later
  #filter(!(sample %in% c("2.a.dd6"))) %>%

  # choose which day to plot 
  filter(day %in% c(2)) %>%
  # choose an experiment 
  filter(experiment_replicate %in% c("dd7", "dd6"))



ggplot(CC_plot, aes(x = OD, y = dilution_rate, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 1) + 
  labs(x = "OD", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_minimal()

```







Compare my OD data with Kaleigh's OD data 

```{r}
# from DD2 and DD3
KD_data <- read.csv("data/KD/KD_final_data.csv")

# from DD4
dd4 <- read.csv("data/KD/dd4_OD.csv")
dd4 <- dd4 %>%
  filter(read_date == "29/06/2024") %>%
  mutate(blank_OD = absorb_600[bioreactor == "blank"],          
         OD_blanked = absorb_600 - blank_OD) %>%
  select(OD_blanked, bioreactor) %>%
  mutate(experiment_replicate = "dd4")

# join together all of KD's data
KD_data <- KD_data %>%
  left_join(dd4) %>%
  mutate(final_od = ifelse(experiment_replicate == "dd4", 
                           OD_blanked,
                           final_od))

# join in my data from dd6
merged <- CC_plot %>%
  select(c(experiment_replicate, OD_blanked, dilution_rate, sample, ID)) %>%
  rename(mean_dil_inv_hr = dilution_rate) %>%
  
  # choose day 2 or day 3
  rename(final_od = OD_blanked) %>%
  filter(sample == "2.b") %>%
  
  # average day 2 and day 3
  #filter(sample %in% c("2.b", "3.b")) %>%
  #group_by(ID, mean_dil_inv_hr, experiment_replicate) %>%
  #summarise(final_od = mean(OD_blanked)) %>%
  #ungroup() %>%

  full_join(KD_data)
```

```{r, fig.height=4, fig.width=7}
merged_plotting <- merged %>%
  filter(experiment_replicate %in% c("dd2", "dd3", "dd4", "dd6")) %>%
  filter(final_od > 0)

ggplot(merged_plotting, aes(x = final_od, 
                            y = mean_dil_inv_hr, 
                            color = experiment_replicate)) +
  geom_point() + 
  labs(x = "OD", y = "Dilution rate (ml/hour/ml)", color = "Experiment") +
  theme_minimal()
```

End points for the experiments: 
DD2 - Day 2 
DD3 - Day 4 / Day 6 
DD4 - Day 4 
DD6 - Day 2 / Day 3



Compare CFUs across the dd experiments 

- ahhhh I see the problem! In Kaleigh's code she seems to make a small mistake on L373 - uses undiluted (i.e., full dot, which is 5ul) rather than cfus per ul! 

```{r}
KD_cfu <- KD_data %>%
  select(experiment_replicate, mean_dil_inv_hr, cfu_per_ul_tf) %>%
  filter(experiment_replicate %in% c("dd2", "dd3", "dd4")) %>%
  distinct()

JO_cfu <- CC_plot %>%
  filter(sample == "2.b") %>%
  select(experiment_replicate, cfu_ul, dilution_rate) %>%
  rename(cfu_per_ul_tf = cfu_ul) %>%
  rename(mean_dil_inv_hr = dilution_rate)

combined_cfu <- rbind(KD_cfu, JO_cfu)
```

```{r, fig.height=4, fig.width=7}

ggplot(combined_cfu, aes(x = cfu_per_ul_tf, 
                         y = mean_dil_inv_hr, 
                         color = experiment_replicate)) +
  geom_point() + 
  labs(x = "CFU (per ul)", y = "Dilution rate (ml/hour/ml)", color = "Experiment") +
  theme_minimal()
```













Check correlation between outflow volume and inflow setting

```{r, fig.width=4, fig.height=4}
ggplot(CC, aes(x = inflow_setting, y = outflow_mean)) +
  geom_point() +  # Scatter plot points
  geom_text(aes(label = ID), vjust = 1.5, hjust = 0, size = 3) + 
  labs(x = "Inflow setting", y = "Outflow (ml/day") +
  theme_minimal()
```


Check correlation between before and after sampling on day 2 

```{r, fig.width=4, fig.height=4}

CC_wide <- CC %>%
  
  select(ID, sample, cfu_ul) %>%
  
    pivot_wider(names_from = sample, 
                values_from = cfu_ul, 
                names_prefix = "cfu_ul_") %>%
  
  filter(ID != "M5")


ggplot(CC_wide, aes(x = cfu_ul_2.b, y = cfu_ul_2.a)) +
  geom_point() +  # Scatter plot points
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_text(aes(label = ID), vjust = 1.5, hjust = 0, size = 3) + 
  labs(x = "CFU Before", y = "CFU After") +
  theme_minimal()

```





