---
title: "dd6"
output: html_notebook
author: James Orr
---

Quick look at dd6 results

Set up 

```{r}
#### Required packages
library(tidyverse)        

#### Clear  environment 
rm(list = ls())   
```

Load data

```{r}
CC <- read.csv("data/cfu_counts_JO.csv")

outflow <- read.csv("data/outflow_rates_JO.csv")
```


Average counts

```{r}
CC <- CC %>%
  mutate(av_counts = rowMeans(across(dot1:dot10), na.rm = TRUE))
```

Densities

```{r}
CC <- CC %>%
  
  # multiply by 10^dilution factor to get CFUs per ul 
  # first row is 100ul of sample so it would be: count * 10 ^ 1 to get 1ul
  # six row would be: count * 10 ^ 6 to get to 1ul
  # remember that the very first row is diluted!
  mutate(cfu_undil = av_counts * 10 ^ dilution_factor) %>%
  
  # each dot is 5ul, so divide by 5 to get counts per ul
  mutate(cfu_ul = cfu_undil / 5)

```

Create sampling factor 

```{r}
CC <- CC %>%
  
  # removes the counts from the overnights
  filter(day != 0) %>%
  
  # factor for every combination of day and time
  mutate(sample = interaction(day, time))
```

Join in outflow volumes 

```{r}
# mean outflow volume across day 1 and day 2 per bioreactor
outflow <- outflow %>%
  select(c(bioreactor, day_measured, volume_out)) %>%
  group_by(bioreactor) %>%
  summarise(outflow_mean = mean(volume_out))

# join the mean outflow volume into colony count data (by ID/bioreactor)
CC <- CC %>%
  left_join(outflow, by = c("ID" = "bioreactor"))
```

Calculate dilution rate (this seems to be what Kaleigh used for y axis)

```{r}
CC <- CC %>%
  
  # volume coming in every hour (in ml)
  mutate(outflow_per_hour = outflow_mean/24) %>%
  
  # as a fraction of the volume of the vial (21ml) to get rate of dilution 
  mutate(dilution_rate = outflow_per_hour/21)
```


Quick plots of CFUs by inflow setting 

```{r, fig.height=4, fig.width=7}

# removing the control (all at 0) and M1 reactor - pump failed on first day
CC_plot <- CC %>%
  filter(!(ID %in% c("M1", "M5")))

ggplot(CC_plot, aes(x = cfu_ul, y = inflow_setting, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 10) + 
  labs(x = "CFU/μL", y = "Inflow Setting", color = "Sample") +
  theme_minimal()

```
1b = sampling on the first day (before inflow)
2b = sampling on the second day (before inflow)
2a = sampling on the second day (after inflow)
3b = sampling on the third day (before inflow)

```{r}
ggplot(CC_plot, aes(x = cfu_ul, y = inflow_setting, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 10) + 
  labs(x = "CFU/μL", y = "Inflow Setting", color = "Sample") +
  theme_light() +
  facet_wrap(~ sample, scales = "free_x")
```

Quick plot of CFUs by dilution rate

```{r, fig.height=4, fig.width=7}

CC_plot <- CC %>%
  filter(!(ID %in% c("M1", "M5")))

ggplot(CC_plot, aes(x = cfu_ul, y = dilution_rate, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 1) + 
  labs(x = "CFU/μL", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_minimal()

```

```{r}
ggplot(CC_plot, aes(x = cfu_ul, y = dilution_rate, color = sample)) +
  geom_point() + 
  #geom_smooth(method = "loess", se = FALSE, span = 10) + 
  labs(x = "CFU/μL", y = "Dilution rate (ml/hour/ml)", color = "Sample") +
  theme_light() +
  facet_wrap(~ sample, scales = "free_x")
```

Check correlation between before and after sampling on day 2 

```{r, fig.width=4, fig.height=4}

CC_wide <- CC %>%
  
  select(ID, sample, cfu_ul) %>%
  
    pivot_wider(names_from = sample, 
                values_from = cfu_ul, 
                names_prefix = "cfu_ul_") %>%
  
  filter(ID != "M5")


ggplot(CC_wide, aes(x = cfu_ul_2.b, y = cfu_ul_2.a)) +
  geom_point() +  # Scatter plot points
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  geom_text(aes(label = ID), vjust = 1.5, hjust = 0, size = 3) + 
  labs(x = "CFU Before", y = "CFU After") +
  theme_minimal()

```

